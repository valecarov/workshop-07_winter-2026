---
title: "Linear regression: Abalone growth and pH example"
author: "Valentina Caro"
date: "02-26-2026"
format:
  html:
    toc: true # use this to display a table of contents
execute:
  message: false # use this to make sure messages don't show up
  warning: false # use this to make sure warnings don't show up
---

# Set up

```{r libraries-and-data}
library(tidyverse) # general use
library(janitor) # cleaning data frames
library(here) # file/folder organization
library(readxl) # reading .xlsx files
library(ggeffects) # generating model predictions
library(gtsummary) # generating summary tables for models

# abalone data from Hamilton et al. 2022
abalone <- read_xlsx(here("data", "Abalone IMTA_growth and pH.xlsx"))
```

# Abalone example

Data from Hamilton et al. 2022. "Integrated multi-trophic aquaculture mitigates the effects of ocean acidification: Seaweeds raise system pH and improve growth of juvenile abalone." https://doi.org/10.1016/j.aquaculture.2022.738571

## a. Questions and hypotheses

Question: How does pH predict abalone growth (measured in change in shell surface area per day, mm^-2^ d^-1^)?  

H~0~: **[pH does not predict abalone growth (change in shell surface area per day, m^2^d^-1^)]**  

H~A~: **[pH does predict abalone growth (change in shell surface area per day, m^2^d^-1^)]**

## b. Cleaning

```{r abalone-data-cleaning}

abalone_clean <- abalone  |> 
  # creating new object called abalone clean from original data frame
  clean_names()  |> 
  # cleaning column names
  select(mean_p_h, change_in_area_mm2_d_1_25)  |> 
  # selecting columns of interest
  rename(mean_ph = mean_p_h, 
         change_in_area = change_in_area_mm2_d_1_25)
  # renaming columns for clarity
```

Don't forget to look at your data! Use `View(abalone_clean)` in the _Console_.

## c. Exploratory data visualization

```{r abalone-scatterplot}
#| warning: false
# base layer: ggplot
ggplot(data = abalone_clean, # starting with clean data frame
       aes(x = mean_ph, # axis axis should be pH, y axis should be change in shell area
           y = change_in_area)) +
  # first layer: points to represent abalones
  geom_point(size = 4,
             stroke = 1,
             fill = "firebrick4",
             shape = 21)
```

Where does the missing value come from?  

**Tank B1B, missing a pH reading**  

Don't forget to turn your warnings off either in the individual code chunk or in the YAML at the top of the file.

## d. Abalone model

### Model fitting

```{r abalone-model}
abalone_model <- lm(
  change_in_area ~ mean_ph, # formula: response formula ~ predictor variable
  data = abalone_clean      # data: clean abalone data frame
)
```

### Diagnostics

```{r abalone-model-diagnostics}

par(mfrow = c(2, 2))   # displaying diagnostic plots in 2x2 grid
plot(abalone_model)    # plotting diagnostics

```

**Residuals seem homoscedastic based on residuals vs fitted and scale location plots. Residuals seem normally distributed based on qq plot. No major outliers based on residuals vs leverage plot.**

Written Communication: **We evaluated model assumptions visually. For homoscedasticity of residuals, we used residuals vs fitted and scale location plots. For normality, we used qq plots. Based on our diagnostics, there were no major deviations from homoscedasticity or normality of residuals. There were also no outliers that might influence model estimates or predictions**

### Model summary

```{r abalone-model-summary}

# more information about the model
summary(abalone_model)

```

What is the slope estimate (with standard error?)  

**3.0 +- 0.8 (SE). With each incrase in pH, the model predicts n increase of 3.0 +- 0.8 in change in shell area per day (mm^2^d^-1)**  

What is the intercept estimate (with standard error?)  

**-18.5 +- 6.2 (SE). When pH is equal to zero, the model predicts that abalone change in shell area per day is -18.5 (Note to self: this is not necessarily biologically realistic, but is something the model generates**

### Generating predictions

```{r abalone-model-predictions}

# creating a new object called abalone_preds
abalone_preds <- ggpredict(
  abalone_model,      # model object
  terms = "mean_ph"   # predictor (in quotation marks)
)

# display the predictions
abalone_preds
```

Look at the column names using `colnames(abalone_preds)` in the Console.  

What are the column names?  

**x (predictor variable) **  
**predicted (model predictions for change in shell surface per day)**
**std.error *(standard error describing precision in model predictions )**
**conf.low and conf.high (lower and upper bounds of 95% confidence interval around model predictions)**

Look at the actual object (by clicking on it in Environment).  

Look at the class of the object using `class(abalone_preds)` in the Console.  

What is this type of object?  

**ggeffects output object and a data frame**  

View `abalone_preds` like a data frame. 

### Why generate model predictions?  

This dataset does not include any _actual_ observations of abalone growth at pH = 8.  

However, the model can tell us a _prediction_ for what abalone growth could be if pH = 8 based on the existing data.  

Figure out what abalone growth the model would _predict_ at pH = 8.

```{r}
# finding the model prediction at a specific value
ggpredict(
  abalone_model,      # model object
  terms = "mean_ph[8]"   # predictor (in quotation marks) and predictor value in brackets
)
```

How would you interpret this?  

**At pH = 8 the model predicts that abalone shell changge in surface area per day should be 5.36 mm^2^day^-1 (95 CI: (5.08, 5.64))**

### Visualizing model predictions and data

```{r abalone-model-final-figure}

# base layer: ggplot
# using clean data frame
ggplot(data = abalone_clean,
       aes(x = mean_ph,
           y = change_in_area)) +
  # first layer: points representing abalones
  geom_point(size = 4,
             stroke = 1,
             fill = "firebrick4",
             shape = 21) +
  # second layer: ribbon representing confidence interval
  # using predictions data frame
  geom_ribbon(data = abalone_preds,
              aes(x = x,
                  y = predicted,
                  ymin = conf.low,
                  ymax = conf.high),
              alpha = 0.1) +
  # third layer: line representing model predictions
  # using predictions data frame
  geom_line(data = abalone_preds,
            aes(x = x,
                y = predicted)) +
  # axis labels
  labs(x = "Mean pH", 
       y = expression("Change in shell area ("*mm^{2}~d^-1*")")) +
  # theme
  theme_minimal()
```

### Creating a table with model coefficients, 95% confidence intervals, and more

**Note:** both these functions are from `gtsummary`.

```{r abalone-table}
tbl_regression(abalone_model,
               # make sure the y-intercept estimate is shown
               intercept = TRUE,
               # changing labels in "Characteristic" column
               label = list(`(Intercept)` = "Intercept",
                            mean_ph = "pH")) |> 
  # changing header text
  modify_header(label = "**Variable**",
                estimate = "**Estimate**") |> 
  # turning table into a flextable (makes things easier to render to word or PDF)
  as_flex_table()
```

**END OF ABALONE EXAMPLE**